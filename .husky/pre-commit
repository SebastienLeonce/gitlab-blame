#!/usr/bin/env sh

echo "ğŸ” Pre-commit quality checks..."
echo ""

# Check for staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tsx?$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "ğŸ“ Running ESLint on staged files..."
  if ! npm run lint; then
    echo ""
    echo "âŒ ESLint failed. Fix errors and try again."
    echo "   Or use: git commit --no-verify (not recommended)"
    exit 1
  fi
  echo "âœ… ESLint passed"
  echo ""

  echo "ğŸ” Running TypeScript type check..."
  if ! npm run typecheck; then
    echo ""
    echo "âŒ TypeScript type check failed. Fix type errors and try again."
    echo "   Or use: git commit --no-verify (not recommended)"
    exit 1
  fi
  echo "âœ… Type check passed"
  echo ""
else
  echo "â„¹ï¸  No TypeScript files staged, skipping lint/typecheck"
  echo ""
fi

# Validate package-lock.json is in sync with package.json
PKG_JSON_CHANGED=$(git diff --cached --name-only | grep '^package.json$' || true)
PKG_LOCK_CHANGED=$(git diff --cached --name-only | grep '^package-lock.json$' || true)

if [ -n "$PKG_JSON_CHANGED" ] || [ -n "$PKG_LOCK_CHANGED" ]; then
  echo "ğŸ” Validating package-lock.json sync..."
  if ! npm ci --dry-run --silent 2>/dev/null; then
    echo ""
    echo "âŒ package-lock.json is out of sync with package.json"
    echo ""
    npm ci --dry-run 2>&1 | head -15
    echo ""
    echo "ğŸ“ To fix:"
    echo "   1. Run: npm install"
    echo "   2. Review changes: git diff package-lock.json"
    echo "   3. Stage the changes: git add package-lock.json"
    echo "   4. Commit again"
    echo ""
    echo "   Or use: git commit --no-verify (not recommended - CI will fail)"
    exit 1
  fi
  echo "âœ… package-lock.json is in sync"
  echo ""
fi

# Documentation sync reminder (non-blocking)
SRC_CHANGED=$(git diff --cached --name-only | grep '^src/' || true)
REF_CHANGED=$(git diff --cached --name-only | grep '^ref/' || true)
CLAUDE_MD_CHANGED=$(git diff --cached --name-only | grep '^CLAUDE.md' || true)

if [ -n "$SRC_CHANGED" ] && [ -z "$REF_CHANGED" ] && [ -z "$CLAUDE_MD_CHANGED" ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ DOCUMENTATION SYNC REMINDER"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "You modified src/ files but didn't update documentation."
  echo ""
  echo "Consider updating:"
  echo "  â€¢ ref/api/services.md       - if you changed service interfaces"
  echo "  â€¢ ref/api/providers.md      - if you changed provider interfaces"
  echo "  â€¢ ref/api/utilities.md      - if you changed utility functions"
  echo "  â€¢ ref/architecture.md       - if you changed system architecture"
  echo "  â€¢ ref/patterns.md           - if you added new coding patterns"
  echo "  â€¢ ref/configuration.md      - if you changed settings/commands"
  echo "  â€¢ CLAUDE.md                 - if you changed project structure/commands"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Press Enter to continue anyway, or Ctrl+C to abort and update docs..."
  read -r
  echo ""
fi

echo "âœ… Pre-commit checks passed!"
echo ""
