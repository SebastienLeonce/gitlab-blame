#!/usr/bin/env sh

echo "ğŸ” Pre-commit quality checks..."
echo ""

# Check for staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tsx?$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "ğŸ“ Running ESLint on staged files..."
  if ! npm run lint; then
    echo ""
    echo "âŒ ESLint failed. Fix errors and try again."
    echo "   Or use: git commit --no-verify (not recommended)"
    exit 1
  fi
  echo "âœ… ESLint passed"
  echo ""

  echo "ğŸ” Running TypeScript type check..."
  if ! npm run typecheck; then
    echo ""
    echo "âŒ TypeScript type check failed. Fix type errors and try again."
    echo "   Or use: git commit --no-verify (not recommended)"
    exit 1
  fi
  echo "âœ… Type check passed"
  echo ""
else
  echo "â„¹ï¸  No TypeScript files staged, skipping lint/typecheck"
  echo ""
fi

# Documentation sync reminder (non-blocking)
SRC_CHANGED=$(git diff --cached --name-only | grep '^src/' || true)
REF_CHANGED=$(git diff --cached --name-only | grep '^ref/' || true)
CLAUDE_MD_CHANGED=$(git diff --cached --name-only | grep '^CLAUDE.md' || true)

if [ -n "$SRC_CHANGED" ] && [ -z "$REF_CHANGED" ] && [ -z "$CLAUDE_MD_CHANGED" ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ DOCUMENTATION SYNC REMINDER"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "You modified src/ files but didn't update documentation."
  echo ""
  echo "Consider updating:"
  echo "  â€¢ ref/api/services.md       - if you changed service interfaces"
  echo "  â€¢ ref/api/providers.md      - if you changed provider interfaces"
  echo "  â€¢ ref/api/utilities.md      - if you changed utility functions"
  echo "  â€¢ ref/architecture.md       - if you changed system architecture"
  echo "  â€¢ ref/patterns.md           - if you added new coding patterns"
  echo "  â€¢ ref/configuration.md      - if you changed settings/commands"
  echo "  â€¢ CLAUDE.md                 - if you changed project structure/commands"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Press Enter to continue anyway, or Ctrl+C to abort and update docs..."
  read -r
  echo ""
fi

echo "âœ… Pre-commit checks passed!"
echo ""
