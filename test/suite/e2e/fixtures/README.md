# E2E Test Fixtures

This directory contains git repository fixtures for E2E testing of the Git Blame MR/PR Link extension.

## Overview

### test-repo

A minimal Git repository fixture for testing GitBlame functionality.

**Structure**:
- Single commit: `feat: add user authentication (#1)`
- Single file: `src/auth.ts`
- Remote: `git@github.com:test-owner/test-repo.git`
- Author: "Test Author" <test@example.com>
- Date: 2024-01-15T10:00:00Z (deterministic)

**Key Features**:
- Deterministic commit SHA (via `GIT_AUTHOR_DATE` and `GIT_COMMITTER_DATE` env vars)
- Auto-regenerates `.git` directory if missing (CI-friendly)
- Single commit with PR reference (#1) for testing GitHub/GitLab integration

## Modifying the Fixture

### Adding a New Commit

Follow these steps to add a new commit to the fixture:

1. **Navigate to fixture directory**:
   ```bash
   cd test/suite/e2e/fixtures/test-repo
   ```

2. **Make your changes** (add/modify files):
   ```bash
   # Example: Add a new file
   mkdir -p src
   echo "export const config = {};" > src/config.ts
   git add .
   ```

3. **Commit with deterministic date**:
   ```bash
   GIT_AUTHOR_DATE="2024-01-20T10:00:00Z" \
   GIT_COMMITTER_DATE="2024-01-20T10:00:00Z" \
   git commit -m "feat: add configuration (#2)"
   ```

   **Important**: Always use deterministic dates to ensure reproducible commit SHAs.

4. **Update `FIXTURE_COMMITS` constant**:

   Edit `test/suite/e2e/helpers/fixtureRepo.ts` and add the new commit to the array:

   ```typescript
   export const FIXTURE_COMMITS: FixtureCommit[] = [
     {
       id: "commit-1",
       message: "feat: add user authentication (#1)",
       author: "Test Author",
       date: "2024-01-15T10:00:00Z",
       files: [{ name: "src/auth.ts", content: "" }],
       prNumber: 1,
     },
     {
       id: "commit-2",  // NEW
       message: "feat: add configuration (#2)",
       author: "Test Author",
       date: "2024-01-20T10:00:00Z",
       files: [{ name: "src/config.ts", content: "" }],
       prNumber: 2,
     },
   ];
   ```

5. **Run validation**:
   ```bash
   npm run fixture:verify
   ```

   This ensures your fixture matches the `FIXTURE_COMMITS` definition.

6. **Update tests** (if needed):

   If your tests reference specific commit SHAs or file content, update them accordingly.

### Modifying Existing Files

1. Navigate to fixture directory:
   ```bash
   cd test/suite/e2e/fixtures/test-repo
   ```

2. Modify the file:
   ```bash
   echo "// Updated content" >> src/auth.ts
   git add .
   ```

3. Create an amend commit or new commit (use deterministic dates):
   ```bash
   GIT_AUTHOR_DATE="2024-01-15T10:00:00Z" \
   GIT_COMMITTER_DATE="2024-01-15T10:00:00Z" \
   git commit --amend --no-edit
   ```

   **Note**: Amending changes the commit SHA. Tests using the old SHA will need updates.

4. Update `FIXTURE_COMMITS` if needed and run validation.

### Changing Git Configuration

To modify the remote URL, author, or other git config:

```bash
cd test/suite/e2e/fixtures/test-repo

# Change remote URL
git remote set-url origin git@gitlab.com:test-owner/test-repo.git

# Change author (for existing commits, requires rebase)
git config user.name "Different Author"
git config user.email "different@example.com"
```

Remember to update `FIXTURE_COMMITS` and `fixtureRepo.ts` to match.

## Fixture Regeneration & .git Directory Handling

### Previous Approach: Excluded .git Directory (No Longer Used)

**Note**: This project previously excluded the `.git` directory. As of December 2024, we now commit it for faster CI and convenience.

The `.git` directory was **excluded from version control** (via `.gitignore`) and regenerated on demand.

**How it works**:
- `.gitignore` excludes `test/suite/e2e/fixtures/test-repo/.git/`
- On first run (or after `npm run fixture:clean`), `.git` is automatically regenerated by `FixtureRepository.setup()`
- Regeneration uses deterministic dates to ensure reproducible commit SHAs

**Pros**:
- ✅ Cleaner version control (no git metadata in repo)
- ✅ Smaller repository size
- ✅ Clear separation: code vs. test artifacts
- ✅ Forces deterministic fixture creation

**Cons**:
- ❌ First-run delay (must regenerate .git)
- ❌ CI/CD must regenerate on every run
- ❌ Extra complexity in fixture setup code

### Alternative Approach: Committed .git Directory

You can optionally commit the `.git` directory for convenience.

**How to switch**:
1. Remove exclusion from `.gitignore`:
   ```bash
   # Comment out or remove line 33 in .gitignore:
   # test/suite/e2e/fixtures/test-repo/.git/
   ```

2. Add `.git` to version control:
   ```bash
   git add test/suite/e2e/fixtures/test-repo/.git
   git commit -m "chore(test): commit fixture .git for faster CI"
   ```

**Pros**:
- ✅ Faster CI/CD (no regeneration needed)
- ✅ Immediate usage after checkout
- ✅ Simpler fixture setup (no regeneration logic needed)
- ✅ Fixture state immediately visible in git

**Cons**:
- ❌ Larger repository (~100KB git metadata)
- ❌ Git metadata in version control (unconventional)
- ❌ Must remember to update .git when modifying fixtures

### Recommendation

**Use current approach (excluded .git)** unless:
- ⚠️ CI/CD runs are taking too long
- ⚠️ Team frequently modifies fixtures and wants immediate visibility
- ⚠️ Fixture regeneration is causing reliability issues

**Experiment before committing**:
1. Try committing `.git` on a feature branch
2. Measure CI time improvement
3. Survey team: Easier or harder to work with?
4. Revert if benefits don't outweigh costs

### Current Status

**✅ Status: .git directory is committed (alternative approach)**

The fixture `.git` directory is committed to version control for:
- ✅ Faster CI/CD (no regeneration delay)
- ✅ Immediate usability after checkout
- ✅ Simpler developer experience

**Trade-off**: +140KB repository size.

If you need to regenerate .git (e.g., after corruption), run `npm run fixture:rebuild`.

### Reverting to Excluded .git Approach

If you want to switch back to excluding .git:

1. Add exclusion to `.gitignore`:
   ```bash
   echo "test/suite/e2e/fixtures/test-repo/.git/" >> .gitignore
   ```

2. Remove .git from version control:
   ```bash
   git rm -r --cached test/suite/e2e/fixtures/test-repo/.git
   git commit -m "chore(test): exclude fixture .git for cleaner version control"
   ```

3. Update documentation:
   - Revert `fixtureRepo.ts` JSDoc comment (test/suite/e2e/helpers/fixtureRepo.ts:49-51)
   - Update README.md "Current Status" section
   - Update CONTRIBUTING.md fixture section

### When Regeneration Happens

- **First run** after cloning the repo
- **CI environments** (clean workspace)
- **After running** `npm run fixture:clean`

### How Regeneration Works

The `FixtureRepository` class in `test/suite/e2e/helpers/fixtureRepo.ts` recreates the git history:

1. Initializes git repo (`git init`)
2. Sets git config (user.email, user.name)
3. Adds remote origin
4. Stages all files (`git add .`)
5. Commits with deterministic dates (matching `FIXTURE_COMMITS`)

This ensures tests work consistently across all environments.

## Fixture Management Scripts

Use these npm scripts to manage fixtures:

### `npm run fixture:clean`

Removes the `.git` directory from the fixture repo, forcing regeneration on next test run.

**Use when**:
- Testing fixture initialization logic
- Fixture `.git` is corrupted
- Want to start fresh

```bash
npm run fixture:clean
```

### `npm run fixture:rebuild`

Cleans the `.git` directory and rebuilds the entire test environment (compile + copy fixtures).

**Use when**:
- Made manual changes to fixture files
- Want to ensure fixture is in sync with code
- Preparing for a clean test run

```bash
npm run fixture:rebuild
```

### `npm run fixture:verify`

Runs validation tests to ensure fixture integrity matches `FIXTURE_COMMITS` definition.

**Use when**:
- After modifying fixture
- Before committing changes
- Debugging test failures related to fixtures

```bash
npm run fixture:verify
```

**Validation checks**:
- ✅ `.git` directory exists
- ✅ Commit count matches `FIXTURE_COMMITS.length`
- ✅ Commit messages match `FIXTURE_COMMITS[].message`
- ✅ Expected files exist (`FIXTURE_COMMITS[].files`)
- ✅ Remote URL matches expected value

## Best Practices

### ✅ DO

- **Use deterministic dates**: Always set `GIT_AUTHOR_DATE` and `GIT_COMMITTER_DATE`
- **Update `FIXTURE_COMMITS`**: Keep code in sync with fixture state
- **Run validation**: Use `npm run fixture:verify` after changes
- **Document changes**: Update this README if adding complex scenarios
- **Test locally**: Verify tests pass before pushing

### ❌ DON'T

- **Don't use current dates**: Avoid `git commit` without env vars (SHAs will vary)
- **Don't commit `.git`**: It's excluded for a reason (auto-regenerates)
- **Don't skip validation**: Always verify fixture integrity
- **Don't hardcode SHAs in tests**: Use `fixtureRepo.getActualSha("commit-1")` instead

## Troubleshooting

### Tests fail with "Git repository not found"

**Cause**: `.git` directory is missing.

**Solution**:
```bash
npm run fixture:rebuild
```

### Tests fail with "SHA mismatch"

**Cause**: Fixture commit SHA doesn't match what tests expect.

**Solution**:
1. Check if `FIXTURE_COMMITS` matches actual fixture state
2. Run `npm run fixture:verify` to identify mismatches
3. Update `FIXTURE_COMMITS` or regenerate fixture

### Validation fails with "Commit count mismatch"

**Cause**: Number of commits in fixture doesn't match `FIXTURE_COMMITS.length`.

**Solution**:
1. Check commit history: `cd test/suite/e2e/fixtures/test-repo && git log --oneline`
2. Update `FIXTURE_COMMITS` to match actual commits
3. Or clean and rebuild: `npm run fixture:rebuild`

### Fixture modifications not reflected in tests

**Cause**: Tests use compiled fixtures in `out/test/suite/e2e/fixtures/`.

**Solution**:
```bash
npm run fixture:rebuild
```

This recompiles and copies fixtures to the output directory.

## Further Reading

- **Fixture management code**: `test/suite/e2e/helpers/fixtureRepo.ts`
- **Test setup**: `test/suite/e2e/helpers/suiteSetup.ts`
- **Test constants**: `test/suite/e2e/helpers/testConstants.ts`
- **Contributing guide**: `CONTRIBUTING.md` (section: "Modifying E2E Fixtures")
