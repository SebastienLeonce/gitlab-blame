name: Publish Extension

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (v1.0.0, v0.2.1, etc.)

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write     # For creating GitHub releases and pushing tags
      pull-requests: read # For future PR integration (optional but good practice)
      id-token: write     # For OIDC/provenance (future-proofing)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Extract version from tag (v1.2.3 ‚Üí 1.2.3)
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # Read version from package.json
      - name: Get package.json version
        id: package_version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      # Verify versions match (fail if mismatch)
      - name: Verify version match
        run: |
          if [ "${{ steps.get_version.outputs.VERSION }}" != "${{ steps.package_version.outputs.VERSION }}" ]; then
            echo "‚ùå Version mismatch!"
            echo "Git tag version: ${{ steps.get_version.outputs.VERSION }}"
            echo "package.json version: ${{ steps.package_version.outputs.VERSION }}"
            echo ""
            echo "Please ensure package.json version matches the git tag."
            exit 1
          fi
          echo "‚úÖ Versions match: ${{ steps.get_version.outputs.VERSION }}"

      # Run quality checks
      - name: Run typecheck
        run: npm run typecheck

      - name: Run lint
        run: npm run lint

      - name: Build extension
        run: npm run build

      - name: Package extension
        run: npm run package

      - name: List generated package
        run: ls -lh *.vsix

      - name: Run tests
        run: |
          npm run pretest
          xvfb-run -a npm test
        env:
          DISPLAY: ':99.0'

      - name: Prepare E2E tests
        run: npm run pretest:e2e
        timeout-minutes: 5

      - name: Run E2E tests
        run: xvfb-run -a npm run test:e2e
        timeout-minutes: 10
        env:
          DISPLAY: ':99.0'

      # Publish to Open VSX Registry
      - name: Publish to Open VSX Registry
        uses: HaaLeo/publish-vscode-extension@v2
        id: publish-openvsx
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
        continue-on-error: true

      # Publish to VS Code Marketplace
      - name: Publish to VS Code Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        id: publish-vscode
        with:
          pat: ${{ secrets.VSCE_PAT }}
          registryUrl: https://marketplace.visualstudio.com

      # Report publishing status
      - name: Report publishing status
        if: always()
        run: |
          echo "üìä Publishing Status Report"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Open VSX Registry: ${{ steps.publish-openvsx.outcome }}"
          echo "VS Code Marketplace: ${{ steps.publish-vscode.outcome }}"
          echo ""
          if [ "${{ steps.publish-vscode.outcome }}" != "success" ]; then
            echo "‚ùå VS Code Marketplace publishing failed!"
            exit 1
          fi
          if [ "${{ steps.publish-openvsx.outcome }}" != "success" ]; then
            echo "‚ö†Ô∏è  Open VSX Registry publishing failed, but VS Marketplace succeeded"
            echo "üí° You may need to publish to Open VSX manually:"
            echo "    npx ovsx publish -p <OPEN_VSX_TOKEN>"
          fi

      # Enhanced error reporting
      - name: Publish failure notice
        if: failure()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå PUBLISH WORKFLOW FAILED"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "Version: ${{ steps.get_version.outputs.VERSION }}"
          echo "Tag: ${{ github.ref_name }}"
          echo ""
          echo "üìù RECOVERY STEPS:"
          echo ""
          echo "1. Fix the failing tests/checks locally"
          echo "2. Commit and push fixes to main"
          echo "3. Bump to next patch version:"
          echo "   npm run version:patch"
          echo "   git push origin main"
          echo ""
          echo "See: ref/release-process.md ¬ßTroubleshooting"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      # Generate changelog for this release
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            # Get commits since previous tag (exclude release commit using HEAD^)
            CHANGELOG=$(git log ${PREV_TAG}..HEAD^ --pretty=format:"- %s (%h)" --reverse)
          fi

          # Save to file (escape for GitHub Actions)
          echo "$CHANGELOG" > /tmp/changelog.txt
          {
            echo "CHANGELOG<<EOF"
            cat /tmp/changelog.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.PREV_TAG }}...${{ github.ref_name }}
          files: |
            *.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Upload .vsix as artifact
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-vsix
          path: '*.vsix'
          retention-days: 90
